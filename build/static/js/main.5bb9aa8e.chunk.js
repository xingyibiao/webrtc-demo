(this["webpackJsonpav-chat"]=this["webpackJsonpav-chat"]||[]).push([[0],{169:function(e,t,n){e.exports=n(286)},175:function(e,t,n){},251:function(e,t){},283:function(e,t,n){},286:function(e,t,n){"use strict";n.r(t);var r=n(0),a=n.n(r),c=n(7),s=n.n(c),o=(n(143),n(174),n(71)),i=n(27),u=n(72),l=n(52),f=function(){function e(){Object(u.a)(this,e),this.info={userName:"",roomName:""};var t=localStorage.getItem("userInfo");if(t)try{var n=JSON.parse(t);this.setInfo(n)}catch(r){console.error("\u83b7\u53d6\u672c\u5730\u7528\u6237\u4fe1\u606f\u5931\u8d25")}}return Object(l.a)(e,null,[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}]),Object(l.a)(e,[{key:"setInfo",value:function(e){this.info=e,localStorage.setItem("userInfo",JSON.stringify(e))}},{key:"getInfo",value:function(){return this.info}}]),e}();f.instance=void 0;var d=f.getInstance(),m=n(19),h=n(287),p=n(13),v=n(37),b=(n(175),function(){var e=Object(r.useState)(""),t=Object(m.a)(e,2),n=t[0],c=t[1],s=Object(r.useState)(""),o=Object(m.a)(s,2),u=o[0],l=o[1],f=Object(i.f)();return a.a.createElement("div",{className:"login"},a.a.createElement("div",{className:"loginForm"},a.a.createElement("h1",null,"\u903c\u683cthan\u903c\u683cdemo"),a.a.createElement("div",{className:"form--item"},a.a.createElement(h.a,{value:n,placeholder:"\u8bf7\u8f93\u5165\u7528\u6237\u540d",prefix:a.a.createElement(p.a,{type:"user"}),onChange:function(e){return c(e.target.value)}})),a.a.createElement("div",{className:"form--item"},a.a.createElement(h.a,{value:u,placeholder:"\u8bf7\u8f93\u5165\u623f\u95f4\u53f7",prefix:a.a.createElement(p.a,{type:"lock"}),onChange:function(e){return l(e.target.value)}})),a.a.createElement("div",{className:"form--item"},a.a.createElement(v.a,{type:"primary",onClick:function(){n&&u&&(d.setInfo({userName:n,roomName:u}),f.push("/room/".concat(u)),window.location.reload())}},"\u767b\u5f55"))))}),k=n(108),g=n(10),w=n.n(g),O=n(21),y=n(74),E=n.n(y),x=n(165),j=(n(283),[{urls:"stun:stun01.sipphone.com"},{urls:"stun:stun.ekiga.net"},{urls:"stun:stun.fwdnet.net"},{urls:"stun:stun.ideasip.com"},{urls:"stun:stun.iptel.org"},{urls:"stun:stun.rixtelecom.se"},{urls:"stun:stun.schlund.de"},{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stunserver.org"},{urls:"stun:stun.softjoys.com"},{urls:"stun:stun.voiparound.com"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.voipstunt.com"},{urls:"stun:stun.voxgratia.org"},{urls:"stun:stun.xten.com"},{urls:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"},{urls:"turn:192.158.29.39:3478?transport=udp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"},{urls:"turn:192.158.29.39:3478?transport=tcp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"}]),S=Object({NODE_ENV:"production",PUBLIC_URL:"/build",REACT_APP_SOCKET_URL:"wss://www.xingyibiao.com/"}),C=S.REACT_APP_SOCKET_URL||"",N="production"===S.NODE_ENV?"/chat/socket.io":"/socket.io",P=E()(C,{path:N,forceNew:!0,reconnection:!1,transports:["websocket"]}),I=!1,L=!1,R=[],A=function(){var e=Object(i.f)(),t=d.getInfo(),n=t.userName,c=t.roomName;n||e.replace("/login");var s=Object(r.useRef)(null),o=Object(r.useRef)(null),u=Object(r.useState)(""),l=Object(m.a)(u,2),f=(l[0],l[1],Object(r.useState)(0)),p=Object(m.a)(f,2),b=p[0],g=p[1],y=Object(r.useState)(0),E=Object(m.a)(y,2),S=E[0],C=E[1],N=Object(r.useState)((function(){return R})),A=Object(m.a)(N,2),_=A[0],V=A[1],D=Object(r.useState)(""),T=Object(m.a)(D,2),U=T[0],$=T[1],J=Object(r.useState)(!1),B=Object(m.a)(J,2),z=B[0],K=B[1];function F(){var e=document.querySelector("#chat--list");if(e){var t=e.getBoundingClientRect(),n=t.height,r=t.width;g(n),C(r)}}window.addEventListener("resize",F),Object(r.useEffect)((function(){return console.log("effect"),F(),function(){return window.removeEventListener("resize",F)}}),[c]);var G=null,M=null,Q=!0,W=!1,Y=new RTCPeerConnection({iceServers:j});function Z(){return q.apply(this,arguments)}function q(){return(q=Object(O.a)(w.a.mark((function e(){var t;return w.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!W){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,Y.createOffer();case 5:if(t=e.sent,W=!0,!t.sdp){e.next=11;break}return e.next=10,Y.setLocalDescription(t);case 10:P.emit("send_sdp",t);case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),console.error(e.t0);case 16:case"end":return e.stop()}}),e,null,[[2,13]])})))).apply(this,arguments)}function H(){return X.apply(this,arguments)}function X(){return(X=Object(O.a)(w.a.mark((function e(){var t;return w.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!W){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,Y.createAnswer();case 5:if(t=e.sent,W=!0,!t.sdp){e.next=11;break}return e.next=10,Y.setLocalDescription(t);case 10:P.emit("send_sdp",t);case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),console.error(e.t0);case 16:case"end":return e.stop()}}),e,null,[[2,13]])})))).apply(this,arguments)}function ee(){return te.apply(this,arguments)}function te(){return(te=Object(O.a)(w.a.mark((function e(){return w.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(G){e.next=2;break}return e.abrupt("return");case 2:if(G.getTracks().forEach((function(e){G&&Y.addTrack(e,G)})),!Q){e.next=8;break}return e.next=6,Z();case 6:e.next=10;break;case 8:return e.next=10,H();case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ne(){return(ne=Object(O.a)(w.a.mark((function e(){return w.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Q=!0,e.next=3,ee();case 3:P.emit("call");case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}return L||(L=!0,Y.addEventListener("track",(function(e){var t=o.current;M=e.streams[0],t&&t.srcObject!==e.streams[0]&&(t.srcObject=M)})),Y.addEventListener("icecandidate",(function(e){P.emit("candidate",e.candidate)}))),I||(I=!0,P.on("send_sdp",function(){var e=Object(O.a)(w.a.mark((function e(t){var r,a;return w.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.sender,a=t.data,console.log("\u6536\u5230sdp",t),r!==n){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,Y.setRemoteDescription(a);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),P.on("candidate",function(){var e=Object(O.a)(w.a.mark((function e(t){var r,a;return w.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.sender,a=t.data,r!==n){e.next=3;break}return e.abrupt("return");case 3:if(a){e.next=5;break}return e.abrupt("return");case 5:return e.prev=5,console.log(a),e.next=9,Y.addIceCandidate(a);case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(5),console.error(e.t0);case 14:case"end":return e.stop()}}),e,null,[[5,11]])})));return function(t){return e.apply(this,arguments)}}()),P.on("call",(function(e){e.sender!==n&&(K(!0),Q=!1,ee())})),P.on("chat",(function(e){console.log("\u6536\u5230\u6d88\u606f",_,e),V([].concat(Object(k.a)(_),[e]))}))),Y.addEventListener("negotiationneeded",(function(e){console.log("rtc state",Y.signalingState),Y.signalingState})),a.a.createElement("div",{className:"App"},a.a.createElement("div",{className:"left"}),a.a.createElement("div",{className:"center"}),a.a.createElement("div",{className:"right"},a.a.createElement("div",{className:"video--wrap"},a.a.createElement("video",{ref:o,width:"200",height:"150",autoPlay:!0}),a.a.createElement("video",{ref:s,width:"80",height:"60",autoPlay:!0,muted:!0})),a.a.createElement("div",{id:"chat--list",className:"chat--list"},a.a.createElement(x.a,{width:S,height:b,rowHeight:20,rowCount:20,rowRenderer:function(e){var t=e.key,n=e.index,r=e.style;return a.a.createElement("div",{key:t,style:r},_[n])}})),a.a.createElement(h.a,{placeholder:"\u8bf4\u70b9\u4ec0\u4e48",value:U,onChange:function(e){return $(e.target.value)},onKeyDown:function(e){"Enter"===e.key&&P.emit("chat",U,(function(e){$(""),V([].concat(Object(k.a)(_),[e]))}))}}),a.a.createElement(v.a,{onClick:function(){navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then((function(e){s.current&&(s.current.srcObject=e,G=e)})).catch((function(e){console.error(e)}))}},"\u91c7\u96c6\u672c\u5730\u89c6\u9891"),a.a.createElement(v.a,{onClick:function(){P.emit("login",n,c,(function(e){Q=e,console.log("\u662f\u4e0d\u662f\u53d1\u5e03\u8005",e)}))}},"\u767b\u5f55\u623f\u95f4"),a.a.createElement(v.a,{disabled:z,onClick:function(){return ne.apply(this,arguments)}},"call")))},_=n(288),V=n(166),D=n(155),T=n(167),U=n(156),$={width:200,height:200},J=function(e){function t(e,n,r){var a;return Object(u.a)(this,t),(a=Object(V.a)(this,Object(D.a)(t).call(this))).container=e,a.constraints=n,a.socket=null,a.rtc=null,a.localVideo$=null,a.remoteVideo$=null,a.localStream=null,a.remoteStream=null,a.userName="",a.roomName="",a.isPublisher=!1,a.hasInit=!1,a.hasPublish=!1,a.containerStyle=void 0,a.agreeCall=!1,a.receiveSap=!1,a.containerStyle=Object.assign({},$,r),a}return Object(T.a)(t,e),Object(l.a)(t,null,[{key:"getClientInstance",value:function(e,n){return t.clientInstance||(t.clientInstance=new t(e,n)),t.clientInstance}},{key:"setSocketOptions",value:function(e){t.socketOptions=e}},{key:"setScocketUrl",value:function(e){t.socketUrl=this.socketUrl}},{key:"setRtcConfig",value:function(e){t.rtcConfig=e}}]),Object(l.a)(t,[{key:"initContainer",value:function(){if(this.container){var e=document.createElement("video"),t=document.createElement("video"),n=this.containerStyle,r=n.width,a=n.height;this.container.setAttribute("style","position: relative; width: ".concat(r,"px; height: ").concat(a,"px")),e.width=.25*r,e.height=.25*a,e.style.background="#999",e.style.position="absolute",e.style.bottom="0",e.style.right="0",e.setAttribute("autoPlay","autoPlay"),e.setAttribute("mute","mute"),t.width=r,t.height=a,t.style.background="#000",t.style.position="absolute",t.setAttribute("autoPlay","autoPlay"),this.localVideo$=e,this.remoteVideo$=t,this.container.appendChild(t),this.container.appendChild(t),this.container.appendChild(e)}}},{key:"init",value:function(){var e=this;this.initContainer();return new Promise((function(n,r){if(console.log("\u5f00\u59cbinit",e.hasInit),e.hasInit)r("\u91cd\u590dinit");else{var a=t.socketUrl,c=t.socketOptions,s=t.rtcConfig;e.socket=E()(a,c),e.rtc=new RTCPeerConnection(s),e.socket.addEventListener("connect",(function(){n()})),e.rtc.addEventListener("signalingstatechange",(function(e){console.log("signalingstatechange",e)})),e.rtc.addEventListener("connectionstatechange",(function(){if(console.log("rtc connectionStateChange"),e.rtc){var t=e.rtc.connectionState;console.log("connectionState %s",t)}})),e.socket.addEventListener("error",(function(){return r()})),e.addSocketListener(),e.addRtcListener()}}))}},{key:"addSocketListener",value:function(){var e=this;this.socket&&(this.socket.on("send_sdp",function(){var t=Object(O.a)(w.a.mark((function t(n){var r,a;return w.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=n.sender,a=n.data,console.log("\u6536\u5230sdp",n),r!==e.userName){t.next=4;break}return t.abrupt("return");case 4:if(e.receiveSap=!0,!e.rtc){t.next=9;break}return t.next=8,e.rtc.setRemoteDescription(a);case 8:e.agreeCall&&e.publishStream();case 9:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),this.socket.on("candidate",function(){var t=Object(O.a)(w.a.mark((function t(n){var r,a;return w.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=n.sender,a=n.data,r!==e.userName){t.next=3;break}return t.abrupt("return");case 3:if(a){t.next=5;break}return t.abrupt("return");case 5:if(t.prev=5,!e.rtc){t.next=9;break}return t.next=9,e.rtc.addIceCandidate(a);case 9:t.next=14;break;case 11:t.prev=11,t.t0=t.catch(5),console.error(t.t0);case 14:case"end":return t.stop()}}),t,null,[[5,11]])})));return function(e){return t.apply(this,arguments)}}()),this.socket.on("call",(function(t){var n=t.sender;n!==e.userName&&(e.emit("call",n),e.isPublisher=!1,e.publishStream())})))}},{key:"addRtcListener",value:function(){var e=this;this.rtc&&(this.rtc.addEventListener("track",(function(t){console.log("\u8fdc\u7aeftrack\u589e\u52a0",t.streams);var n=t.streams[0];e.remoteStream=n,e.remoteVideo$&&e.remoteVideo$.srcObject!==t.streams[0]&&(e.remoteVideo$.srcObject=n)})),this.rtc.addEventListener("icecandidate",(function(t){e.socket&&e.socket.emit("candidate",t.candidate)})))}},{key:"login",value:function(e,t){var n=this;return new Promise((function(r,a){if(!n.socket)return a("socket\u672a\u8fde\u63a5");n.socket.emit("login",t,e,(function(r){r.success?(n.userName=t,n.roomName=e,n.isPublisher=r.isPublisher):a("\u767b\u5f55\u5931\u8d25"),console.log("\u662f\u4e0d\u662f\u53d1\u5e03\u8005",r)}))}))}},{key:"publishStream",value:function(){var e=this;return new Promise(function(){var t=Object(O.a)(w.a.mark((function t(n,r){return w.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.initLocalStream();case 3:return t.next=5,e.addTrack();case 5:if(console.log("isPublisher",e.isPublisher),!e.isPublisher){t.next=11;break}return t.next=9,e.createOffer();case 9:t.next=13;break;case 11:return t.next=13,e.createAnswer();case 13:n("\u53d1\u5e03\u6d41\u6210\u529f"),t.next=19;break;case 16:t.prev=16,t.t0=t.catch(0),r(t.t0);case 19:case"end":return t.stop()}}),t,null,[[0,16]])})));return function(e,n){return t.apply(this,arguments)}}())}},{key:"call",value:function(){var e=this;this.socket&&this.socket.emit("call","",(function(t){console.log("call cb",t),e.isPublisher=!0,e.publishStream()}))}},{key:"agree",value:function(){this.agreeCall=!0,this.receiveSap&&this.publishStream()}},{key:"initLocalStream",value:function(){var e=this;return new Promise((function(t,n){navigator.mediaDevices.getUserMedia(e.constraints).then((function(n){e.localStream=n,e.localVideo$&&(e.localVideo$.srcObject=n),t()})).catch((function(e){return n(e)}))}))}},{key:"createOffer",value:function(){var e=this;return this.hasPublish?Promise.resolve(!0):new Promise(function(){var t=Object(O.a)(w.a.mark((function t(n,r){var a;return w.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,e.rtc){t.next=3;break}return t.abrupt("return",r(!1));case 3:return t.next=5,e.rtc.createOffer();case 5:if(a=t.sent,e.hasPublish=!0,!a.sdp){t.next=12;break}return t.next=10,e.rtc.setLocalDescription(a);case 10:e.socket&&e.socket.emit("send_sdp",a),n(!0);case 12:t.next=17;break;case 14:t.prev=14,t.t0=t.catch(0),r(t.t0);case 17:case"end":return t.stop()}}),t,null,[[0,14]])})));return function(e,n){return t.apply(this,arguments)}}())}},{key:"createAnswer",value:function(){var e=this;return this.hasPublish?Promise.resolve(!0):new Promise(function(){var t=Object(O.a)(w.a.mark((function t(n,r){var a;return w.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,e.rtc){t.next=3;break}return t.abrupt("return",r(!1));case 3:return t.next=5,e.rtc.createAnswer();case 5:if(a=t.sent,e.hasPublish=!0,!a.sdp){t.next=12;break}return t.next=10,e.rtc.setLocalDescription(a);case 10:e.socket&&e.socket.emit("send_sdp",a),n(!0);case 12:t.next=18;break;case 14:t.prev=14,t.t0=t.catch(0),console.error("create answer error",t.t0),r(t.t0);case 18:case"end":return t.stop()}}),t,null,[[0,14]])})));return function(e,n){return t.apply(this,arguments)}}())}},{key:"addTrack",value:function(){var e=this;return new Promise((function(t,n){if(!e.localStream)return n(!1);e.localStream.getTracks().forEach((function(r){return e.rtc&&e.localStream?(e.rtc.addTrack(r,e.localStream),void t(!0)):n(!1)}))}))}},{key:"resetState",value:function(){this.socket=null,this.rtc=null,this.agreeCall=!1,this.isPublisher=!1}},{key:"destroy",value:function(){this.socket&&this.socket.close(),this.rtc&&this.rtc.close(),this.resetState()}}]),t}(n.n(U).a);J.clientInstance=void 0,J.socketOptions={path:N,forceNew:!0,reconnection:!1,transports:["websocket"]},J.socketUrl=C,J.rtcConfig={iceServers:j};var B=null,z=!1,K=function(){var e=Object(i.g)().id,t=Object(i.f)().replace,n=Object(r.useState)(!1),c=Object(m.a)(n,2),s=c[0],o=c[1],u=Object(r.useState)(""),l=Object(m.a)(u,2),f=l[0],h=l[1],p=Object(r.useState)(!1),b=Object(m.a)(p,2),k=b[0],g=b[1],w=Object(r.useRef)(null),O=d.getInfo(),y=O.userName,E=O.roomName;function x(){o(!1)}return y&&E||t("/login"),Object(r.useEffect)((function(){var e=w.current;if(e)return(B=J.getClientInstance(e,{video:!0,audio:!0})).init().then((function(){z=!0,console.log("webRtc init success"),B.addListener("call",(function(e){g(!0),h(e),o(!0)}))})).catch((function(e){z=!1,console.error("webRrc init error",e)})),function(){z=!1,B&&B.destroy()}}),[e]),a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:"room"},a.a.createElement("div",{className:"room--left"},e),a.a.createElement("div",{className:"room--middle"},"middle"),a.a.createElement("div",{className:"room--right"},a.a.createElement("div",{className:"btn__list"},a.a.createElement(v.a,{onClick:function(){z&&B&&B.login(E,y).then((function(e){console.log("webrtc \u767b\u5f55\u6210\u529f")})).catch((function(e){console.error("webrtc\u767b\u5f55\u5931\u8d25 e")}))}},"login"),a.a.createElement(v.a,{onClick:function(){k||z&&B&&B.call()},disabled:k},"call")),a.a.createElement("div",{id:"video--wrap",ref:w}))),a.a.createElement(_.a,{visible:s,onOk:function(){x(),B&&B.agree()},onCancel:x},f," call you, Do you agree?"))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(a.a.createElement((function(){var e=d.getInfo();return console.log(e),a.a.createElement(o.a,{basename:"build"},a.a.createElement(i.c,null,a.a.createElement(i.a,{path:"/",component:A,exact:!0}),a.a.createElement(i.a,{path:"/login",component:b}),a.a.createElement(i.a,{path:"/room/:id",component:K})))}),null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))}},[[169,1,2]]]);
//# sourceMappingURL=main.5bb9aa8e.chunk.js.map